var __awaiter=this&&this.__awaiter||function(t,e,r,o){return new(r||(r=Promise))(function(a,i){function n(t){try{l(o.next(t))}catch(t){i(t)}}function s(t){try{l(o.throw(t))}catch(t){i(t)}}function l(t){t.done?a(t.value):new r(function(e){e(t.value)}).then(n,s)}l((o=o.apply(t,e||[])).next())})};$(()=>__awaiter(this,void 0,void 0,function*(){const t=class{constructor(){this.geturiv=$("html").html().match(/\/\/nijie.poyashi.me\/main\.js.*?"/)[0],this.defaultExps={mozamoza:new RegExp(/<img class="mozamoza ngtag" illust_id=.*? user_id=/g),mainContainer:new RegExp(/<div class="clear-left clearfix">.*?<div class="kabu">/g),mainContainerNotLeft:new RegExp(/<div class="clearfix">.*?<div class="kabu">/g),memIndex:new RegExp(/<div class="mem-index clearboth">.*?<div class="kabu">/g),membersMainContainer:new RegExp(/<div id="members_dlsite_left" class="clearboth">.*?<div id="members_right">/g),memIndexToApplication:new RegExp(/<div class=("|')mem-index clearboth("|')>(.|\n)*?<script type=("|')application\/ld\+json("|')>/g),formMethod:new RegExp(/<form method="post" name="content_delete".*?<div class="delete_footer_button">/g)},this.promptText="DLするページ範囲を選択してください。\n書式:XX-YY(XXページからYYページまで) または ZZ(ZZページのみ)",this.commonErrorMes="エラーが発生しました。コンソールを参照してください。",this.box="mozamoza",this.urlPrefix="?",this.str=[],this.array=[]}destructor(){this.str=[],this.array=[],this.startPoint=null,this.endPoint=null,console.log("destructor method called - all processes has been perished")}setTarget(t){this.target=t}ajax(t){return __awaiter(this,void 0,void 0,function*(){try{return yield e.wait(300),{data:yield $.ajax(t,{type:"GET",dataType:"html"}),error:!1}}catch(t){return 404===t.status?{data:null,error:!1}:(console.log(t,"at private method ajax()"),{data:t.message,error:!0})}})}view(){return __awaiter(this,void 0,void 0,function*(){const t=e.getUrlVars();return this.array=[t.id],yield this.getImg(),0})}likeduser(){return __awaiter(this,void 0,void 0,function*(){return this.container="mainContainer",this.execute()})}userpage(){return __awaiter(this,void 0,void 0,function*(){const t=e.getUrlVars(),r=window.location.href.match(".+/(.+?)([?#;].*)?$")[1];return this.container="members_illust.php"===r?"membersMainContainer":"memIndexToApplication",this.urlPrefix="?id="+t.id,this.execute()})}likeview(){return __awaiter(this,void 0,void 0,function*(){const t=e.getUrlVars();return this.container="memIndex",this.urlPrefix="?id="+t.id,this.execute()})}illustview(){return __awaiter(this,void 0,void 0,function*(){return this.container="mainContainer",this.execute()})}okazu(){return __awaiter(this,void 0,void 0,function*(){e.showBg();const t=$("#okazu_list").html().match(/<a href="\/view.php\?id=\d{1,15}"/g);for(let e=0;e<t.length;++e)this.array.push(t[e].match(/\d{1,15}/g)[0]),$("#details").html(`<p>PROGRESS: ${e} of ${t.length} (${100*Math.round(e/t.length)} %)<br>${t[e].match(/\d{1,15}/g)[0]}</p>`);return yield this.getImg(),0})}search(){return __awaiter(this,void 0,void 0,function*(){let t=e.getUrlVars();return t.sort||(t.sort="0"),t.illust_type||(t.illust_type="0"),t.word||(t.word=""),t.sort=Number(t.sort),t.illust_type=Number(t.illust_type),this.urlPrefix=`?sort=${t.sort}&illust_type=${t.illust_type}&word=${t.word}`,this.container="mainContainerNotLeft",this.execute()})}favorite(){return __awaiter(this,void 0,void 0,function*(){let t=e.getUrlVars();return t.sort||(t.sort=0),t.sort=Number(t.sort),this.container="formMethod",this.urlPrefix="?sort="+t.sort,this.execute()})}execute(){return __awaiter(this,void 0,void 0,function*(){const t=this.showRangePrompt();if(!t)return 1;if(e.showBg(),~t.indexOf("-")){const e=t.split("-");this.startPoint=Number(e[0]),this.endPoint=Number(e[1]);for(let t=this.startPoint;t<this.endPoint+1;++t){const{res:e,error:r}=yield this.scraper(this.urlPrefix+"&p="+t);if(r)return 1;Array.prototype.push.apply(this.array,e)}}else{const{res:e,error:r}=yield this.scraper(this.urlPrefix+"&p="+t);if(r)return 1;Array.prototype.push.apply(this.array,e)}return this.array?(yield this.getImg(),0):1})}showRangePrompt(){let t=window.prompt(this.promptText,"");return t?(t=t.replace(/[Ａ-Ｚａ-ｚ０-９]/g,t=>String.fromCharCode(t.charCodeAt(0)-65248)).replace(/(ー|－|―)/g,"-")).match(/^(\d+\-\d+|\d+)$/)?t:(alert("フォーマットにエラーがあります。"),this.showRangePrompt()):null}scraper(t){return __awaiter(this,void 0,void 0,function*(){let r=[];const o="//nijie.info/"+this.target+t,{data:a,error:i}=yield this.ajax(o);console.log(o);try{if(i)throw new Error("thrownError");let o=a.match(this.defaultExps[this.container]);if(!o)throw new Error("noimg");if(!(o=o[0].match(this.defaultExps[this.box])))throw new Error("noimg");for(let e=0;e<o.length;++e){const a=o[e].match(/\d{1,7}/g)[0];r.push(a);const i=t.match(/(?<=\&p\=)\d+/)[0];$("#details").html(`<p>GETTING ILLUST SUMMARY: (${i} of ${this.startPoint?this.endPoint-this.startPoint+1:i})</p>`)}return{res:r,error:!1}}catch(t){switch(console.log(t,t.message),t.message){case"noimg":e.noImg();break;case"thrownError":alert(this.commonErrorMes)}return{error:!0,res:[]}}})}getImg(){return __awaiter(this,void 0,void 0,function*(){let t=[],e=0,r=0,o=0;const a=this.array.length;for(let i=0;i<a;i++){const{data:n,error:s}=yield this.ajax("//nijie.info/view_popup.php?id="+this.array[i]);if(s)return console.log(n),alert(this.commonErrorMes),!1;if(null===n)continue;e++;let l=n.match(/<div id=('|")img_window('|").*?<div id=('|")view-center('|")/g)[0].match(/('|")\/\/pic(|\d+).*?('|")/g),c=n.match(/<title>.*?<\/title>/),d=n.match(/<meta name="twitter:url".*?<meta name="twitter:title"/);d=d[0].match(/\d{1,15}/);for(let i=0;i<l.length;i++)if(o++,this.geturiv.match(/storage=(2|3)/)){let t=new Object;if(!l[i].match(/(sp| \/|small)/)){l[i]=l[i].replace(/"/g,"");let e=!1;t.id=d[0],t.illustrator=c[0].replace(/(ニジエ|<title>|<\/title>)/g,"").replace(/\//g,"／").match(/ \| .*? \|/g)[0].replace(/ \| | \|/g,"").replace(/%/g,"％"),t.title=c[0].match(/<title>.*? \| /g)[0].replace(/(<title>| \| )/g,"").replace(/%/g,"％"),t.url=l[i],this.str.push(JSON.stringify(t));for(let t=0;t<localStorage.length;t++){let o=$.parseJSON(localStorage.getItem("illust-"+("0000"+Number(t+1)).slice(-5)));if(o&&o.url.match(l[i].replace(/__rs_l120x120\//g,""))){r++,e=!0;break}}e||this.setItemToStorage(t)}}else l[i].match(/(sp| \/|small)/)||(l[i]=l[i].replace(/"/g,""),t.push("&url="+l[i]+"&title="+c[0].replace(/%/g,"％")+"&id="+d)),$("#details").html(`<p>PROGRESS : ${e} of ${a} completed. (${Math.round(e/a*100)} %)<br>${l[i]}<br>${c}</p>`),e===a&&this.post(t.toString());this.geturiv.match(/storage=2/)&&e==a?this.sendSt2(r,o):this.geturiv.match(/storage=3/)&&e==a&&this.download(o)}})}sendSt2(t,r){const o={def:r+"個の画像を追加しました。\n",dup:t+"個の重複ファイルは追加されませんでした。",conf:"\n現在追加されているファイル一覧をニジエダウンローダに送信しますか？\n(現在"+localStorage.length+"枚追加済み)"},a=0!==t?o.def+o.dup+o.conf:o.def+o.conf,i=0!==t?o.def+o.dup:o.def;return this.geturiv.match("noconf=1")?alert(i):confirm(a)&&(confirm("送信後、localStorageに蓄積されたファイル一覧をクリアしますか？")&&localStorage.clear(),$("#details").html("取得に成功しました.ページを移動しています"),this.post(JSON.stringify(localStorage),"lang=jp&storage=2")),e.removeBg(),!0}download(t){let r=this.geturiv.match(/&quot;.*?&quot;/)[0].replace(/&quot;/g,"");if(r||(r="$o"),!this.geturiv.match("noconf=1")&&!confirm(t+"個の画像をダウンロードしますか？"))return $("#_wrapper").fadeOut("slow",function(){$("#_wrapper").remove()}),!1;let o=0,a=new Array;for(let t of this.str){const i=(t=$.parseJSON(t)).url.match(".+/(.+?)([?#;].*)?$")[1],n=i.match(/.*?_/)?i.match(/.*?_/)[0].replace("_",""):"unknown",s=i.split(".")?i.split(".")[1]:"jpg",l=i.split(".")?i.split(".")[0]:"unknown",c=r.replace(/\$o/g,l).replace(/\$r/g,e.formatDate(new Date,"YYYYMMDD")).replace(/\$d/g,e.formatDate(new Date,"hhmmssSSS")).replace(/\$n/,("000"+Number(o+1)).slice(-4)).replace(/\$u/g,t.illustrator).replace(/\$l/g,n).replace(/\$i/g,t.id).replace(/\$t/g,t.title);a.push('{"filename":"'+c+"."+s+'","href":"'+t.url+'"}'),o++}const i=document.createElement("iframe");document.body.appendChild(i),i.contentWindow.name="iflr";const n=document.createElement("form");n.target="iflr",n.action="https://nijie.poyashi.me/download_get.php",n.method="POST";const s=document.createElement("input");return s.type="hidden",s.name="q",s.value=JSON.stringify(a),n.appendChild(s),document.body.appendChild(n),n.submit(),this.str=[],e.removeBg(),!0}post(t,e="?lang=jp"){return $("<form/>",{action:"https://nijie.poyashi.me/dl.php"+e,method:"post"}).append($("<input/>",{type:"hidden",name:"q",value:t})).appendTo(document.body).submit(),!0}setItemToStorage(t){let e,r=0;for(;e="illust-"+("0000"+ ++r).slice(-5),localStorage.getItem(e););localStorage.setItem(e,JSON.stringify(t))}sender(){let t;if($("html").append("<div id='wrapper'><div id='content_downloader_wrapper'>Loading data. Please wait</div></div><img src='' id='thumbs' style='position: absolute;left: 1376px;top: 461px;display:none;z-index: 114514;border: 1px solid #777;box-shadow: 0px 0px 4px #222;'><style>body{transition:.2s; filter:blur(0px)}#content_downloader_wrapper button#send, #content_downloader_wrapper button.close {padding: 10px;font-family: YuGothic,'Yu Gothic',sans-serif;color: #222;width: 30%;font-weight: 500;}#content_downloader_wrapper button#send{background-color:#e6fff9;}#content_downloader_wrapper button.close{background-color:#dddddd;}#content_downloader_wrapper button { background: #efefef; border: 1px solid #ccc; padding: 5px;}#content_downloader_wrapper h1 {font-family: YuGothic,'Yu Gothic',sans-serif;font-weight: 300; border-bottom: 1px solid #888; width: 60%;margin: 5px auto 18px auto; color: #333;}#content_downloader_wrapper table{margin:15px auto; border:1px solid #ccc;}#content_downloader_wrapper{border:1px solid #222; box-shadow:0px 0px 4px #ccc; border-radius:2px; width:80%; height:80%; overflow-y:scroll; padding:15px; background:#fff; color:#222;}#wrapper{text-align:center;position:fixed;z-index:9999; top:0; opacity:1; color:#aaa;background:rgba(65,65,65,0.85);width:100%;height:100%;display:flex; flex-direction:column; justify-content:center;align-items:center;}.pcursor{cursor:pointer !important;}</style>"),$("body").css("filter","blur(15px)"),$("#wrapper").fadeIn(),this.geturiv.match("noconf=1")&&localStorage.length>0){t="<h1>Confirm</h1><p class='sure'>"+localStorage.length+"個のアイテムをダウンローダに送信します。</p><p><button id='send'>Send</button> <button class='close'>Close</button></p><p style='user-select:none;'><input type='checkbox' class='daias pcursor' id='daias'><label for='daias'>送信後に保存されたデータを削除</label></input> | <a class='delallitems pcursor'>保存されたデータを削除</a><table><tr><td>Title</td><td>Illustrator</td><td>Id</td><td>Url</td><td>Delete</td></tr>";for(let e in localStorage)if(localStorage.getItem(e)&&e.match(/illust/)){const r=$.parseJSON(localStorage.getItem(e));t+="<tr><td>"+r.title+"</td><td>"+r.illustrator+"</td><td><a href='http://nijie.info/view.php?id="+r.id+"' target='_blank'>"+r.id+"</a></td><td><a href='http:"+r.url+"' target='_blank' class='thumb'>http:"+r.url+"</a></td><td><button class='delbtn' id='"+e+"'>Delete</button></td></tr>"}t+="</table>\n        <a href='#' class='close'>× Close</a>\n        <p>Nijie Downloader - <a href='https://nijie.poyashi.me/' target='_blank'>nijie.poyashi.me</a> powered by <a href='http://twitter.com/#!/_2r5' target='_blank'>@_2r5</a></p>"}else t=this.geturiv.match("noconf=1")&&0==localStorage.length?"<h1>Error</h1><p class='sure'>キューされたアイテムが存在しません。</p><a class='close' style='cursor:pointer;'>Close</a>":"<h1>Error</h1><p class='sure'>パラメータの値が不正です。<br>storage=<i>Number</i> および noconf=<i>Number</i> を指定し、ページを再読込してください。 </p><a class='close' style='cursor:pointer;'>Close</a>";return $("#content_downloader_wrapper").html(""),$("#content_downloader_wrapper").append(t),0}},e=new class{formatDate(t,e){if(e||(e="YYYY-MM-DD hh:mm:ss.SSS"),(e=(e=(e=(e=(e=(e=e.replace(/YYYY/g,t.getFullYear())).replace(/MM/g,("0"+(t.getMonth()+1)).slice(-2))).replace(/DD/g,("0"+t.getDate()).slice(-2))).replace(/hh/g,("0"+t.getHours()).slice(-2))).replace(/mm/g,("0"+t.getMinutes()).slice(-2))).replace(/ss/g,("0"+t.getSeconds()).slice(-2))).match(/S/g)){const r=("00"+t.getMilliseconds()).slice(-3),o=e.match(/S/g).length;for(let t=0;t<o;t++)e=e.replace(/S/,r.substring(t,t+1))}return e}wait(t){return __awaiter(this,void 0,void 0,function*(){return new Promise(e=>{setTimeout(()=>{e()},t)})})}getUrlVars(){let t={},e=[];const r=window.location.search.slice(1).split("&"),o=r.length;for(let a=0;a<o;a++)t[(e=r[a].split("="))[0]]=e[1];return t}showBg(){$("html").append("<div id='_wrapper'><div class='throbber throbber_large'></div><p>Now Loading...<br><span id='details'></span></p><p><span id='error'></span></p></div><style>#_wrapper{text-align:center;position:fixed;z-index:9999; top:0; opacity:1; color:#aaa;background:rgba(65,65,65,0.85);width:100%;height:100%;display:flex; flex-direction:column; justify-content:center;align-items:center;} .throbber {  width: 50px;  height: 50px; padding-bottom:15px; display: -webkit-box;  display: -webkit-flex;  display: -moz-box;  display: -ms-flexbox;  display: flex;  -webkit-box-align: center;  -webkit-align-items: center;  -moz-box-align: center;  -ms-flex-align: center;  align-items: center;  -webkit-box-pack: center;  -webkit-justify-content: center;  -moz-box-pack: center;  -ms-flex-pack: center;  justify-content: center;} .throbber:after {  display: block;  position: relative;  width: 20px;  height: 20px;  -webkit-animation: rotate 0.6s linear infinite;  -moz-animation: rotate 0.6s linear infinite;  -ms-animation: rotate 0.6s linear infinite;  -o-animation: rotate 0.6s linear infinite;  animation: rotate 0.6s linear infinite;  -webkit-border-radius: 100%;  -moz-border-radius: 100%;  border-radius: 100%;  border-top: 1px solid #545a6a;  border-bottom: 1px solid #d4d4db;  border-left: 1px solid #545a6a;  border-right: 1px solid #d4d4db;  content: '';  opacity: .5;} .throbber.throbber_large:after {  width: 40px;  height: 40px;}@keyframes rotate {  0% {    transform: rotateZ(-360deg);    -webkit-transform: rotateZ(-360deg);    -moz-transform: rotateZ(-360deg);    -o-transform: rotateZ(-360deg);  }  100% {    transform: rotateZ(0deg);    -webkit-transform: rotateZ(0deg);    -moz-transform: rotateZ(0deg);    -o-transform: rotateZ(0deg);  }}@-webkit-keyframes rotate {  0% {    transform: rotateZ(-360deg);    -webkit-transform: rotateZ(-360deg);    -moz-transform: rotateZ(-360deg);    -o-transform: rotateZ(-360deg);  }  100% {    transform: rotateZ(0deg);    -webkit-transform: rotateZ(0deg);    -moz-transform: rotateZ(0deg);    -o-transform: rotateZ(0deg);  }}@-moz-keyframes rotate {  0% {    transform: rotateZ(-360deg);    -webkit-transform: rotateZ(-360deg);    -moz-transform: rotateZ(-360deg);    -o-transform: rotateZ(-360deg);  }  100% {    transform: rotateZ(0deg);    -webkit-transform: rotateZ(0deg);    -moz-transform: rotateZ(0deg);    -o-transform: rotateZ(0deg);  }}@-o-keyframes rotate {  0% {    transform: rotateZ(-360deg);    -webkit-transform: rotateZ(-360deg);    -moz-transform: rotateZ(-360deg);    -o-transform: rotateZ(-360deg);  }  100% {    transform: rotateZ(0deg);    -webkit-transform: rotateZ(0deg);    -moz-transform: rotateZ(0deg);    -o-transform: rotateZ(0deg);  }}</style>"),$("#details").html("")}removeBg(){$("#_wrapper").fadeOut("slow",()=>$("#_wrapper").remove())}noImg(){$("#details").html("<p>表示する画像が見つかりませんでした</p><p><a href='#' class='close'>× 閉じる</a></p><script>$('.close').on('click',function(){$('#_wrapper').fadeOut('slow',function(){$('#_wrapper').remove();});return false;});<\/script>")}};!function(){__awaiter(this,void 0,void 0,function*(){const r=()=>{e.removeBg(),a.destructor()};if(!window.location.href.match("nijie.info"))return alert("対応サイト上でのみ本ブックマークレットをお使いいただけます。");const o=window.location.href.match(".+/(.+?)([?#;].*)?$")[1],a=new t;a.setTarget(o);try{(()=>__awaiter(this,void 0,void 0,function*(){switch(o){case"view_popup.php":case"view.php":return yield a.view();case"like_user_view.php":return yield a.likeduser();case"members_illust.php":case"members_dojin.php":return yield a.userpage();case"okiniiri.php":return yield a.favorite();case"illust_view.php":return yield a.illustview();case"user_like_illust_view.php":return yield a.likeview();case"okazu.php":return yield a.okazu();case"search.php":case"search_all.php":case"search_dojin.php":return yield a.search();case"index.php":case"nijie.info/":return a.sender();default:return 2}}))().then(t=>{2===t&&alert("このページには対応していません。"),r()})}catch(t){alert("エラーが発生したため処理を続行できません。\nコンソールを確認してください。"),console.log(t),r()}return 0})}();var r;$(document).on("click","#send",()=>(r=JSON.stringify(localStorage),$(".daias").is(":checked")&&localStorage.clear(),void(new t).post(r,"?lang=jp&storage=2"))),$.fn.thumbnail=function(){return this.each(()=>{$(this).hover(t=>{$("#thumbs").attr("src",$(":hover")[7].href.replace("nijie.info/","nijie.info/__rs_l120x120/")),$("#thumbs").css("left",t.pageX+10),$("#thumbs").css("top",t.pageY+10),$("#thumbs").show()},function(){$("#thumbs").hide()})})},$(".thumb").thumbnail(),$(document).on("click",".delallitems",()=>{confirm("キューされたアイテムを削除しますか？")&&(()=>{localStorage.clear();$("#content_downloader_wrapper").html('\n      <h1>Error</h1>\n      <p class="sure">キューされたアイテムが存在しません。</p>\n      <a class="close" style="cursor:pointer;">Close</a>')})()}),$(document).on("click",".delbtn",function(){if(confirm("このアイテムをリストから削除しますか?")&&(localStorage.removeItem($(this).attr("id")),$("#"+$(this).attr("id")).parent().parent().remove(),$(".sure").html(localStorage.length+"個のアイテムをダウンローダに送信します。"),0==localStorage.length)){$("#content_downloader_wrapper").html('<h1>Error</h1><p class="sure">キューされたアイテムが存在しません。</p><a class="close" style="cursor:pointer;">Close</a><script>$(".close").on("click",function(){$("body").css("filter","blur(0px)"); $("#wrapper").fadeOut("slow",function(){$("#wrapper").remove();})});<\/script>')}})}));